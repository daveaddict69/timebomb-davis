local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Debris = game:GetService("Debris")

local LocalPlayer = Players.LocalPlayer
local ESCAPE_DISTANCE = 6
local DETECTION_RADIUS = 15
local COOLDOWN = 0.1

local lastEscapeTime = 0

local function d(e,f)
    local g=RaycastParams.new()
    g.FilterDescendantsInstances={f}
    g.FilterType=Enum.RaycastFilterType.Blacklist
    local h=2
    local i={Vector3.new(h,0,0),Vector3.new(-h,0,0),Vector3.new(0,0,h),Vector3.new(0,0,-h)}
    for j,k in ipairs(i) do
        local l=workspace:Raycast(e,k,g)
        if l and l.Instance and l.Instance.CanCollide then return false,l.Normal end
    end
    return true
end

local function m(n,o,p)
    local q={o,o:Cross(Vector3.new(0,1,0)).Unit,-o:Cross(Vector3.new(0,1,0)).Unit,Vector3.new(0,0,1),Vector3.new(1,0,0),Vector3.new(-1,0,0)}
    for r,s in ipairs(q) do
        local t=n+(s*ESCAPE_DISTANCE)
        t=Vector3.new(t.X,n.Y,t.Z)
        local u,v=d(t,p)
        if u then return t,s
        elseif v then
            local w=v:Cross(Vector3.new(0,1,0)).Unit
            if w.Magnitude>0 then
                local x=n+(w*5)
                x=Vector3.new(x.X,n.Y,x.Z)
                if d(x,p) then return x,w end
                local y=-w
                local z=n+(y*5)
                z=Vector3.new(z.X,n.Y,z.Z)
                if d(z,p) then return z,y end
            end
        end
    end
    return n+Vector3.new(0,5,0),Vector3.new(0,1,0)
end

local function A(B)
    local C=tick()
    if C-lastEscapeTime<COOLDOWN then return end
    local D=LocalPlayer.Character
    if not D then return end
    local E=D:FindFirstChild("HumanoidRootPart")
    if not E then return end
    local F=E.Position
    local G=(F-B).Unit
    if G.Magnitude<0.01 then G=Vector3.new(math.random()-0.5,0,math.random()-0.5).Unit end
    local H,I=m(F,G,D)
    E.CFrame=CFrame.new(H,H+E.CFrame.LookVector)
    lastEscapeTime=C
    local J=Instance.new("Part")
    J.Size=Vector3.new(3,3,3)
    J.Position=F
    J.Anchored=true
    J.CanCollide=false
    J.Transparency=0.5
    J.BrickColor=BrickColor.new("Bright blue")
    J.Material=Enum.Material.Neon
    J.Parent=workspace
    local K=Instance.new("Part")
    K.Size=Vector3.new(0.5,0.5,2)
    K.Position=F+(I*1)
    K.Anchored=true
    K.CanCollide=false
    K.CFrame=CFrame.lookAt(K.Position,K.Position+I)
    K.BrickColor=BrickColor.new("Cyan")
    K.Parent=workspace
    Debris:AddItem(J,0.4)
    Debris:AddItem(K,0.4)
end

RunService.Heartbeat:Connect(function()
    local L=LocalPlayer.Character
    if not L then return end
    local M=L:FindFirstChild("HumanoidRootPart")
    if not M then return end
    local N=M.Position
    for O,P in ipairs(Players:GetPlayers()) do
        if P~=LocalPlayer and P.Character then
            local Q=false
            for R,S in ipairs(P.Character:GetChildren()) do
                if S:IsA("Tool") and (S.Name:lower():find("bomb") or S.Name:lower():find("explosive")) then
                    Q=true
                    break
                end
            end
            if Q then
                local T=P.Character:FindFirstChild("HumanoidRootPart")
                if T then
                    local U=(N-T.Position).Magnitude
                    if U<=DETECTION_RADIUS then
                        A(T.Position)
                        break
                    end
                end
            end
        end
    end
end)

LocalPlayer.CharacterAdded:Connect(function()
    lastEscapeTime=0
    task.wait(1)
end)
